<div class="modal-wrapper">
  <div class="modal-header">
    <h2 mat-dialog-title>
      {{ isEditMode ? 'Editar Dispositivo' : 'Nuevo Dispositivo' }}
    </h2>
  </div>

  <mat-dialog-content class="modal-body">
    <form [formGroup]="dispositivoForm" class="dispositivo-form">
      <!-- Primera fila: Modelo y Tipo -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Modelo</mat-label>
          <input matInput formControlName="modelo">
          <mat-icon matPrefix>phone_android</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Tipo</mat-label>
          <input matInput formControlName="tipo" placeholder="Ej: Teléfono, Reloj, Audífonos, Laptop">
          <mat-icon matPrefix>category</mat-icon>
          <mat-hint>Campo abierto</mat-hint>
        </mat-form-field>
      </div>

      <!-- Segunda fila: Marca y Distribuidor -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Marca</mat-label>
          <mat-select formControlName="marca">
            <mat-option *ngFor="let marca of marcas" [value]="marca._id">
              {{ marca.marca }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Select simple para crear -->
        <mat-form-field *ngIf="!isEditMode" appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Distribuidor</mat-label>
          <mat-select formControlName="distribuidor">
            <mat-option *ngFor="let distribuidor of distribuidores" [value]="distribuidor._id">
              {{ distribuidor.nombreRepresentante || distribuidor.representante }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Select múltiple para editar -->
        <mat-form-field *ngIf="isEditMode" appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Distribuidores</mat-label>
          <mat-select formControlName="distribuidor" multiple>
            <mat-option *ngFor="let distribuidor of distribuidores" [value]="distribuidor._id">
              {{ distribuidor.nombreRepresentante || distribuidor.representante }}
            </mat-option>
          </mat-select>
          <mat-hint>Múltiples selecciones</mat-hint>
        </mat-form-field>
      </div>

      <!-- Tercera fila: Foto y Fecha -->
      <div class="form-row">
        <div class="form-field-half">
          <app-image-upload
            label="Foto"
            [formControl]="$any(dispositivoForm.get('foto'))"
            [currentUrl]="dispositivoForm.get('foto')?.value || ''"
            (urlChange)="dispositivoForm.get('foto')?.setValue($event)">
          </app-image-upload>
        </div>

        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Fecha de Publicación</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="fechaPublicacion" placeholder="Seleccionar fecha">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Sección de Especificaciones Técnicas: Grid de 2 columnas -->
      <div class="array-fields-section">
        <h3 class="section-title">Especificaciones Técnicas</h3>
        
        <div class="specs-grid">
          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Tecnología</mat-label>
            <mat-chip-grid #chipGridTecnologia aria-label="Tecnología selection">
              <mat-chip-row *ngFor="let item of getArrayValue('tecnologia')" (removed)="removeFromArray('tecnologia', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar tecnología..." 
                   [matChipInputFor]="chipGridTecnologia"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'tecnologia')">
            <mat-icon matPrefix>memory</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Frecuencias</mat-label>
            <mat-chip-grid #chipGridFrecuencias aria-label="Frecuencias selection">
              <mat-chip-row *ngFor="let item of getArrayValue('frecuencias')" (removed)="removeFromArray('frecuencias', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar frecuencia..." 
                   [matChipInputFor]="chipGridFrecuencias"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'frecuencias')">
            <mat-icon matPrefix>signal_cellular_alt</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Ganancia de Antena</mat-label>
            <mat-chip-grid #chipGridGanancia aria-label="Ganancia de Antena selection">
              <mat-chip-row *ngFor="let item of getArrayValue('gananciaAntena')" (removed)="removeFromArray('gananciaAntena', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar ganancia..." 
                   [matChipInputFor]="chipGridGanancia"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'gananciaAntena')">
            <mat-icon matPrefix>settings_input_antenna</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>EIRP</mat-label>
            <mat-chip-grid #chipGridEIRP aria-label="EIRP selection">
              <mat-chip-row *ngFor="let item of getArrayValue('EIRP')" (removed)="removeFromArray('EIRP', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar EIRP..." 
                   [matChipInputFor]="chipGridEIRP"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'EIRP')">
            <mat-icon matPrefix>power</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Módulo</mat-label>
            <mat-chip-grid #chipGridModulo aria-label="Módulo selection">
              <mat-chip-row *ngFor="let item of getArrayValue('modulo')" (removed)="removeFromArray('modulo', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar módulo..." 
                   [matChipInputFor]="chipGridModulo"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'modulo')">
            <mat-icon matPrefix>developer_board</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="modal-footer" align="end">
    <button mat-button (click)="onCancel()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="onSubmit()">
      {{ isEditMode ? 'Actualizar' : 'Crear' }}
    </button>
  </mat-dialog-actions>
</div>

