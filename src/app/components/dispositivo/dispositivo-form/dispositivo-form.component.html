<div class="modal-wrapper">
  <div class="modal-header">
    <h2 mat-dialog-title>
      {{ isEditMode ? 'Editar Dispositivo' : 'Nuevo Dispositivo' }}
    </h2>
  </div>

  <mat-dialog-content class="modal-body">
    <form [formGroup]="dispositivoForm" class="dispositivo-form">
      <!-- Primera fila: Modelo y Tipo -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Modelo</mat-label>
          <input matInput formControlName="modelo">
          <mat-icon matPrefix>phone_android</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Tipo</mat-label>
          <input matInput formControlName="tipo" placeholder="Ej: Teléfono, Reloj, Audífonos, Laptop">
          <mat-icon matPrefix>category</mat-icon>
          <mat-hint>Campo abierto</mat-hint>
        </mat-form-field>
      </div>

      <!-- Segunda fila: Marca y Distribuidor -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Marca</mat-label>
          <input 
            matInput 
            #marcaInput
            [formControl]="marcaFilterControl"
            [matAutocomplete]="marcaAuto"
            (blur)="onMarcaBlur()">
          <mat-autocomplete 
            #marcaAuto="matAutocomplete"
            (optionSelected)="onMarcaSelected($event.option.value)">
            <mat-option *ngFor="let marca of marcasFiltradas" [value]="marca._id">
              {{ marca.marca }}
            </mat-option>
          </mat-autocomplete>
          <mat-icon matPrefix>branding_watermark</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="marcaInput.focus(); marcaFilterControl.setValue('')">
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
        </mat-form-field>

        <!-- Autocomplete simple para crear -->
        <mat-form-field *ngIf="!isEditMode" appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Distribuidor</mat-label>
          <input 
            matInput 
            #distribuidorInput
            [formControl]="distribuidorFilterControl"
            [matAutocomplete]="distribuidorAuto"
            (blur)="onDistribuidorBlur()">
          <mat-autocomplete 
            #distribuidorAuto="matAutocomplete"
            (optionSelected)="onDistribuidorSelected($event.option.value)">
            <mat-option *ngFor="let distribuidor of distribuidoresFiltrados" [value]="distribuidor._id">
              {{ distribuidor.nombreRepresentante || distribuidor.representante }}
            </mat-option>
          </mat-autocomplete>
          <mat-icon matPrefix>business</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="distribuidorInput.focus(); distribuidorFilterControl.setValue('')">
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
        </mat-form-field>

        <!-- Autocomplete múltiple para editar -->
        <mat-form-field *ngIf="isEditMode" appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Distribuidores</mat-label>
          <input 
            matInput 
            #distribuidorMultipleInput
            [formControl]="distribuidorFilterControl"
            [matAutocomplete]="distribuidorMultipleAuto"
            (blur)="onDistribuidorMultipleBlur()">
          <mat-autocomplete 
            #distribuidorMultipleAuto="matAutocomplete"
            (optionSelected)="onDistribuidorMultipleSelected($event.option.value)">
            <mat-option *ngFor="let distribuidor of distribuidoresFiltrados" [value]="distribuidor._id">
              <span>{{ distribuidor.nombreRepresentante || distribuidor.representante }}</span>
              <mat-icon *ngIf="distribuidor._id && isDistribuidorSelected(distribuidor._id)" class="selected-icon">check</mat-icon>
            </mat-option>
          </mat-autocomplete>
          <mat-icon matPrefix>business</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="distribuidorMultipleInput.focus(); distribuidorFilterControl.setValue('')">
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-hint>Múltiples selecciones - Busca y selecciona</mat-hint>
        </mat-form-field>
      </div>

      <!-- Tercera fila: Foto y Fecha -->
      <div class="form-row">
        <div class="form-field-half">
          <app-image-upload
            label="Foto"
            [formControl]="$any(dispositivoForm.get('foto'))"
            [currentUrl]="dispositivoForm.get('foto')?.value || ''"
            (urlChange)="dispositivoForm.get('foto')?.setValue($event)">
          </app-image-upload>
        </div>

        <mat-form-field appearance="outline" class="form-field-half" [floatLabel]="'always'">
          <mat-label>Fecha de Publicación</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="fechaPublicacion" placeholder="Seleccionar fecha">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Sección de Certificación SUBTEL -->
      <div class="array-fields-section">
        <h3 class="section-title">Certificación SUBTEL</h3>
        
        <div class="specs-grid">
          <!-- Resolución SUBTEL (Radio buttons) - Ocupa toda la fila -->
          <div class="spec-field radio-field full-width">
            <label class="radio-label">
              <mat-icon class="radio-label-icon">gavel</mat-icon>
              Resolución SUBTEL <span class="required-asterisk">*</span>
            </label>
            <mat-radio-group formControlName="resolutionVersion" class="radio-group">
              <mat-radio-button [value]="2017" class="radio-button">Resolución 2017</mat-radio-button>
              <mat-radio-button [value]="2025" class="radio-button">Resolución 2025</mat-radio-button>
            </mat-radio-group>
            <div class="error-message" *ngIf="dispositivoForm.get('resolutionVersion')?.hasError('required') && dispositivoForm.get('resolutionVersion')?.touched">
              La resolución SUBTEL es requerida
            </div>
          </div>

          <!-- Fecha y Oficio en la misma fila - Solo visible si Resolución 2017 -->
          <ng-container *ngIf="dispositivoForm.get('resolutionVersion')?.value === 2017">
            <!-- Fecha Certificación SUBTEL (Datepicker) -->
            <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
              <mat-label>Fecha Certificación SUBTEL</mat-label>
              <input matInput [matDatepicker]="pickerSubtel" formControlName="fechaCertificacionSubtel" placeholder="Seleccionar fecha">
              <mat-datepicker-toggle matIconSuffix [for]="pickerSubtel"></mat-datepicker-toggle>
              <mat-datepicker #pickerSubtel></mat-datepicker>
              <mat-icon matPrefix>calendar_today</mat-icon>
              <mat-hint>Opcional</mat-hint>
            </mat-form-field>

            <!-- Oficio Certificación SUBTEL (Text) -->
            <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
              <mat-label>Oficio Certificación SUBTEL</mat-label>
              <input matInput formControlName="oficioCertificacionSubtel" placeholder="Ej: OF-12345-2026" maxlength="200">
              <mat-icon matPrefix>description</mat-icon>
              <mat-hint>Opcional</mat-hint>
            </mat-form-field>
          </ng-container>
        </div>
      </div>

      <!-- Sección de Especificaciones Técnicas: Grid de 2 columnas - Solo visible si Resolución 2025 -->
      <div class="array-fields-section" *ngIf="dispositivoForm.get('resolutionVersion')?.value === 2025">
        <h3 class="section-title">Especificaciones Técnicas</h3>
        
        <div class="specs-grid">
          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Tecnología</mat-label>
            <mat-chip-grid #chipGridTecnologia aria-label="Tecnología selection" cdkDropList (cdkDropListDropped)="drop($event, 'tecnologia')">
              <mat-chip-row *ngFor="let item of getArrayValue('tecnologia'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('tecnologia', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar tecnología..." 
                   [matChipInputFor]="chipGridTecnologia"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'tecnologia')">
            <mat-icon matPrefix>memory</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Frecuencias</mat-label>
            <mat-chip-grid #chipGridFrecuencias aria-label="Frecuencias selection" cdkDropList (cdkDropListDropped)="drop($event, 'frecuencias')">
              <mat-chip-row *ngFor="let item of getArrayValue('frecuencias'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('frecuencias', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar frecuencia..." 
                   [matChipInputFor]="chipGridFrecuencias"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'frecuencias')">
            <mat-icon matPrefix>signal_cellular_alt</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Ganancia de Antena</mat-label>
            <mat-chip-grid #chipGridGanancia aria-label="Ganancia de Antena selection" cdkDropList (cdkDropListDropped)="drop($event, 'gananciaAntena')">
              <mat-chip-row *ngFor="let item of getArrayValue('gananciaAntena'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('gananciaAntena', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar ganancia..." 
                   [matChipInputFor]="chipGridGanancia"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'gananciaAntena')">
            <mat-icon matPrefix>settings_input_antenna</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>EIRP</mat-label>
            <mat-chip-grid #chipGridEIRP aria-label="EIRP selection" cdkDropList (cdkDropListDropped)="drop($event, 'EIRP')">
              <mat-chip-row *ngFor="let item of getArrayValue('EIRP'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('EIRP', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar EIRP..." 
                   [matChipInputFor]="chipGridEIRP"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'EIRP')">
            <mat-icon matPrefix>power</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Módulo</mat-label>
            <mat-chip-grid #chipGridModulo aria-label="Módulo selection" cdkDropList (cdkDropListDropped)="drop($event, 'modulo')">
              <mat-chip-row *ngFor="let item of getArrayValue('modulo'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('modulo', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Agregar módulo..." 
                   [matChipInputFor]="chipGridModulo"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'modulo')">
            <mat-icon matPrefix>developer_board</mat-icon>
            <mat-hint>Enter o coma</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección de Test Reports - Solo visible si Resolución 2025 -->
      <div class="array-fields-section" *ngIf="dispositivoForm.get('resolutionVersion')?.value === 2025">
        <h3 class="section-title">Test Reports</h3>
        
        <div class="specs-grid">
          <mat-form-field appearance="outline" class="spec-field" [floatLabel]="'always'">
            <mat-label>Nombre Test Report</mat-label>
            <mat-chip-grid #chipGridNombreTestReport aria-label="Nombre Test Report selection" cdkDropList (cdkDropListDropped)="drop($event, 'nombreTestReport')">
              <mat-chip-row *ngFor="let item of getArrayValue('nombreTestReport'); let i = index" 
                            cdkDrag
                            (removed)="removeFromArray('nombreTestReport', item)">
                {{ item }}
                <button matChipRemove [attr.aria-label]="'remove ' + item">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input matInput 
                   matChipInput
                   placeholder="Ej: X6730B WSCT-ANAB-R&E250700055A-BT_1.pdf Pag. 5,7" 
                   [matChipInputFor]="chipGridNombreTestReport"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodesEnterOnly"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="addToArray($event, 'nombreTestReport')">
            <mat-icon matPrefix>description</mat-icon>
            <mat-hint>Presiona Enter para agregar (puedes usar comas en el texto)</mat-hint>
          </mat-form-field>

          <div class="spec-field">
            <app-file-upload
              label="Archivo Test Report"
              [currentUrl]="dispositivoForm.get('testReportFiles')?.value || ''"
              (urlChange)="onTestReportFilesChange($event)">
            </app-file-upload>
          </div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="modal-footer" align="end">
    <button mat-button (click)="onCancel()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="onSubmit()">
      {{ isEditMode ? 'Actualizar' : 'Crear' }}
    </button>
  </mat-dialog-actions>
</div>

